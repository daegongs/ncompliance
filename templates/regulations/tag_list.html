{% extends 'base.html' %}

{% block title %}íƒœê·¸ ëª©ë¡ - ì‚¬ê·œê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'regulations:list' %}">ì‚¬ê·œ ëª©ë¡</a></li>
<li class="breadcrumb-item active">íƒœê·¸</li>
{% endblock %}

{% block extra_css %}
<style>
  /* í†µê³„ ì¹´ë“œ */
  .stats-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    background: #fff;
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .stat-card .stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #4c51bf;
  }
  
  .stat-card .stat-label {
    font-size: 0.85rem;
    color: #718096;
  }
  
  /* ê²€ìƒ‰ */
  .tag-search {
    margin-bottom: 1.5rem;
  }
  
  .tag-search input {
    border-radius: 0.5rem;
    padding: 0.6rem 1rem;
    border: 1px solid #e2e8f0;
    max-width: 300px;
  }
  
  .tag-search input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
  }
  
  /* íƒœê·¸ í…Œì´ë¸” */
  .tag-table {
    background: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    overflow: hidden;
  }
  
  .tag-row {
    display: flex;
    align-items: center;
    border-bottom: 1px solid #e2e8f0;
    transition: background 0.2s;
  }
  
  .tag-row:last-child {
    border-bottom: none;
  }
  
  .tag-row:hover {
    background: #f7fafc;
  }
  
  /* ì¹´í…Œê³ ë¦¬ ë¼ë²¨ (ì™¼ìª½ ì»¬ëŸ¼) */
  .tag-category {
    width: 160px;
    min-width: 160px;
    padding: 0.875rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.85rem;
    border-right: 3px solid;
    background: #f8fafc;
  }
  
  .tag-category i {
    font-size: 1rem;
  }
  
  /* ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ */
  .tag-row.board .tag-category { color: #4c51bf; border-color: #5a67d8; background: #ebf4ff; }
  .tag-row.hr .tag-category { color: #2b6cb0; border-color: #3182ce; background: #ebf8ff; }
  .tag-row.finance .tag-category { color: #285e61; border-color: #319795; background: #e6fffa; }
  .tag-row.compliance .tag-category { color: #276749; border-color: #38a169; background: #f0fff4; }
  .tag-row.security .tag-category { color: #975a16; border-color: #d69e2e; background: #fffff0; }
  .tag-row.procurement .tag-category { color: #c05621; border-color: #dd6b20; background: #fffaf0; }
  .tag-row.audit .tag-category { color: #c53030; border-color: #e53e3e; background: #fff5f5; }
  .tag-row.other .tag-category { color: #6b46c1; border-color: #805ad5; background: #faf5ff; }
  
  /* íƒœê·¸ ëª©ë¡ (ì˜¤ë¥¸ìª½ ì»¬ëŸ¼) */
  .tag-list {
    flex: 1;
    padding: 0.75rem 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }
  
  /* íƒœê·¸ ì•„ì´í…œ */
  .tag-item {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.35rem 0.75rem;
    border-radius: 1rem;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .tag-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .tag-item i {
    font-size: 0.7rem;
  }
  
  .tag-count {
    background: rgba(255,255,255,0.35);
    padding: 0.1rem 0.35rem;
    border-radius: 0.75rem;
    font-size: 0.7rem;
    font-weight: 600;
  }
  
  /* íƒœê·¸ ìƒ‰ìƒ */
  .tag-indigo { background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%); color: #fff; }
  .tag-blue { background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: #fff; }
  .tag-teal { background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); color: #fff; }
  .tag-green { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: #fff; }
  .tag-yellow { background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%); color: #744210; }
  .tag-orange { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: #fff; }
  .tag-red { background: linear-gradient(135deg, #fc8181 0%, #e53e3e 100%); color: #fff; }
  .tag-purple { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: #fff; }
  .tag-pink { background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%); color: #fff; }
  .tag-cyan { background: linear-gradient(135deg, #4fd1c5 0%, #38b2ac 100%); color: #fff; }
  
  /* ë¹ˆ ìƒíƒœ */
  .empty-tags {
    color: #a0aec0;
    font-style: italic;
    font-size: 0.85rem;
  }
  
  /* ë¹ˆ ì „ì²´ ìƒíƒœ */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: #fff;
    border-radius: 0.75rem;
  }
  
  .empty-state i {
    font-size: 4rem;
    color: #cbd5e0;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="page-title mb-0"><i class="bi bi-tags-fill me-2"></i>íƒœê·¸ ê´€ë¦¬</h1>
</div>

{% if is_dept_manager %}
<div class="alert alert-info mb-4">
  <i class="bi bi-info-circle me-2"></i>
  <strong>{{ user.department.name }}</strong> ì†Œì† ì±…ì„ë¶€ì„œë‹´ë‹¹ìë¡œ ë¡œê·¸ì¸í•˜ì…¨ìŠµë‹ˆë‹¤. 
  ë³¸ì¸ì´ ë‹´ë‹¹í•˜ëŠ” ì‚¬ê·œì˜ íƒœê·¸ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
</div>
{% endif %}

    {% if tags %}
<!-- í†µê³„ & ê²€ìƒ‰ -->
<div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-4">
  <div class="stats-row mb-0">
    <div class="stat-card">
      <div class="stat-value">{{ tags|length }}</div>
      <div class="stat-label">ì „ì²´ íƒœê·¸</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ total_regulations }}</div>
      <div class="stat-label">ì „ì²´ ì‚¬ê·œ</div>
    </div>
  </div>
  <div class="tag-search mb-0">
    <input type="text" id="tagSearchInput" class="form-control" placeholder="ğŸ” íƒœê·¸ ê²€ìƒ‰..." onkeyup="filterTags()">
  </div>
</div>

<!-- íƒœê·¸ í…Œì´ë¸” -->
<div class="tag-table">
  <!-- ì´ì‚¬íšŒÂ·ì§€ë°°êµ¬ì¡° -->
  <div class="tag-row board" data-group="board">
    <div class="tag-category">
      <i class="bi bi-diagram-3"></i>
      <span>ì´ì‚¬íšŒÂ·ì§€ë°°êµ¬ì¡°</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name == 'ì´ì‚¬íšŒ' or tag.name == 'ì£¼ì£¼ì´íšŒ' or tag.name == 'ê²½ì˜' or tag.name == 'ì§€ë°°êµ¬ì¡°' or tag.name == 'ì´ì‚¬' or tag.name == 'ê°ì‚¬ìœ„ì›íšŒ' or tag.name == 'ìœ„ì›íšŒ' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item tag-indigo" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
        </a>
        {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
  </div>

  <!-- ì¸ì‚¬Â·HR -->
  <div class="tag-row hr" data-group="hr">
    <div class="tag-category">
      <i class="bi bi-people-fill"></i>
      <span>ì¸ì‚¬Â·HR</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name == 'ì¸ì‚¬' or tag.name == 'ì±„ìš©' or tag.name == 'í‰ê°€' or tag.name == 'ë³´ìƒ' or tag.name == 'êµìœ¡' or tag.name == 'ë³µë¦¬í›„ìƒ' or tag.name == 'ê¸‰ì—¬' or tag.name == 'ê·¼ë¬´' or tag.name == 'íœ´ê°€' or tag.name == 'í‡´ì§' or tag.name == 'ì§•ê³„' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item tag-blue" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
        </a>
        {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
  </div>

  <!-- ì¬ë¬´Â·íšŒê³„ -->
  <div class="tag-row finance" data-group="finance">
    <div class="tag-category">
      <i class="bi bi-currency-dollar"></i>
      <span>ì¬ë¬´Â·íšŒê³„</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name == 'ì¬ë¬´' or tag.name == 'íšŒê³„' or tag.name == 'ì„¸ë¬´' or tag.name == 'ìê¸ˆ' or tag.name == 'ì˜ˆì‚°' or tag.name == 'ê²°ì‚°' or tag.name == 'íˆ¬ì' or tag.name == 'ìì‚°' or tag.name == 'ë¹„ìš©' or tag.name == 'ë§¤ì¶œ' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item tag-teal" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
        </a>
        {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
  </div>

  <!-- ì»´í”Œë¼ì´ì–¸ìŠ¤Â·ì¤€ë²• -->
  <div class="tag-row compliance" data-group="compliance">
    <div class="tag-category">
      <i class="bi bi-shield-check"></i>
      <span>ì»´í”Œë¼ì´ì–¸ìŠ¤Â·ì¤€ë²•</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name == 'ì¤€ë²•' or tag.name == 'ìœ¤ë¦¬' or tag.name == 'ë‚´ë¶€í†µì œ' or tag.name == 'ë°˜ë¶€íŒ¨' or tag.name == 'ê³µì •ê±°ë˜' or tag.name == 'ê·œì œ' or tag.name == 'ë²•ë¥ ' or tag.name == 'ê³„ì•½' or tag.name == 'ì†Œì†¡' or tag.name == 'ë¶„ìŸ' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item tag-green" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
        </a>
        {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
  </div>

  <!-- ë³´ì•ˆÂ·ì •ë³´ë³´í˜¸ -->
  <div class="tag-row security" data-group="security">
    <div class="tag-category">
      <i class="bi bi-lock-fill"></i>
      <span>ë³´ì•ˆÂ·ì •ë³´ë³´í˜¸</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name == 'ë³´ì•ˆ' or tag.name == 'ê°œì¸ì •ë³´' or tag.name == 'ì •ë³´ë³´í˜¸' or tag.name == 'ì‚¬ì´ë²„ë³´ì•ˆ' or tag.name == 'IT' or tag.name == 'ì‹œìŠ¤í…œ' or tag.name == 'ë„¤íŠ¸ì›Œí¬' or tag.name == 'ë°ì´í„°' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item tag-yellow" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
        </a>
        {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
  </div>

  <!-- êµ¬ë§¤Â·ì¡°ë‹¬ -->
  <div class="tag-row procurement" data-group="procurement">
    <div class="tag-category">
      <i class="bi bi-cart-check"></i>
      <span>êµ¬ë§¤Â·ì¡°ë‹¬</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name == 'êµ¬ë§¤' or tag.name == 'ì¡°ë‹¬' or tag.name == 'ì…ì°°' or tag.name == 'ê³µê¸‰' or tag.name == 'í˜‘ë ¥ì‚¬' or tag.name == 'ì™¸ì£¼' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item tag-orange" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
        </a>
        {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
  </div>

  <!-- ê°ì‚¬Â·ë‚´ë¶€ê°ì‚¬ -->
  <div class="tag-row audit" data-group="audit">
    <div class="tag-category">
      <i class="bi bi-search"></i>
      <span>ê°ì‚¬Â·ë‚´ë¶€ê°ì‚¬</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name == 'ê°ì‚¬' or tag.name == 'ë‚´ë¶€ê°ì‚¬' or tag.name == 'ì™¸ë¶€ê°ì‚¬' or tag.name == 'ê²€ì‚¬' or tag.name == 'ì ê²€' or tag.name == 'ëª¨ë‹ˆí„°ë§' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item tag-red" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
      </a>
        {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
    </div>

  <!-- ê¸°íƒ€ -->
  <div class="tag-row other" data-group="other">
    <div class="tag-category">
      <i class="bi bi-collection"></i>
      <span>ê¸°íƒ€</span>
    </div>
    <div class="tag-list">
      {% for tag in tags %}
        {% if tag.name != 'ì´ì‚¬íšŒ' and tag.name != 'ì£¼ì£¼ì´íšŒ' and tag.name != 'ê²½ì˜' and tag.name != 'ì§€ë°°êµ¬ì¡°' and tag.name != 'ì´ì‚¬' and tag.name != 'ê°ì‚¬ìœ„ì›íšŒ' and tag.name != 'ìœ„ì›íšŒ' and tag.name != 'ì¸ì‚¬' and tag.name != 'ì±„ìš©' and tag.name != 'í‰ê°€' and tag.name != 'ë³´ìƒ' and tag.name != 'êµìœ¡' and tag.name != 'ë³µë¦¬í›„ìƒ' and tag.name != 'ê¸‰ì—¬' and tag.name != 'ê·¼ë¬´' and tag.name != 'íœ´ê°€' and tag.name != 'í‡´ì§' and tag.name != 'ì§•ê³„' and tag.name != 'ì¬ë¬´' and tag.name != 'íšŒê³„' and tag.name != 'ì„¸ë¬´' and tag.name != 'ìê¸ˆ' and tag.name != 'ì˜ˆì‚°' and tag.name != 'ê²°ì‚°' and tag.name != 'íˆ¬ì' and tag.name != 'ìì‚°' and tag.name != 'ë¹„ìš©' and tag.name != 'ë§¤ì¶œ' and tag.name != 'ì¤€ë²•' and tag.name != 'ìœ¤ë¦¬' and tag.name != 'ë‚´ë¶€í†µì œ' and tag.name != 'ë°˜ë¶€íŒ¨' and tag.name != 'ê³µì •ê±°ë˜' and tag.name != 'ê·œì œ' and tag.name != 'ë²•ë¥ ' and tag.name != 'ê³„ì•½' and tag.name != 'ì†Œì†¡' and tag.name != 'ë¶„ìŸ' and tag.name != 'ë³´ì•ˆ' and tag.name != 'ê°œì¸ì •ë³´' and tag.name != 'ì •ë³´ë³´í˜¸' and tag.name != 'ì‚¬ì´ë²„ë³´ì•ˆ' and tag.name != 'IT' and tag.name != 'ì‹œìŠ¤í…œ' and tag.name != 'ë„¤íŠ¸ì›Œí¬' and tag.name != 'ë°ì´í„°' and tag.name != 'êµ¬ë§¤' and tag.name != 'ì¡°ë‹¬' and tag.name != 'ì…ì°°' and tag.name != 'ê³µê¸‰' and tag.name != 'í˜‘ë ¥ì‚¬' and tag.name != 'ì™¸ì£¼' and tag.name != 'ê°ì‚¬' and tag.name != 'ë‚´ë¶€ê°ì‚¬' and tag.name != 'ì™¸ë¶€ê°ì‚¬' and tag.name != 'ê²€ì‚¬' and tag.name != 'ì ê²€' and tag.name != 'ëª¨ë‹ˆí„°ë§' %}
        <a href="{% url 'regulations:by_tag' tag.name %}" class="tag-item {% cycle 'tag-purple' 'tag-pink' 'tag-cyan' %}" data-tag="{{ tag.name }}">
          {{ tag.name }}<span class="tag-count">{{ tag.regulation_count }}</span>
        </a>
    {% endif %}
      {% endfor %}
      <span class="empty-tags" style="display:none;">íƒœê·¸ ì—†ìŒ</span>
    </div>
  </div>
</div>

{% else %}
<div class="empty-state">
  <i class="bi bi-tags"></i>
  <h5 class="text-muted">ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
  <p class="text-muted">ì‚¬ê·œì— íƒœê·¸ë¥¼ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function filterTags() {
  const searchText = document.getElementById('tagSearchInput').value.toLowerCase();
  const tagItems = document.querySelectorAll('.tag-item');
  const tagRows = document.querySelectorAll('.tag-row');
  
  tagItems.forEach(item => {
    const tagName = item.getAttribute('data-tag').toLowerCase();
    item.style.display = tagName.includes(searchText) ? 'inline-flex' : 'none';
  });
  
  // ë¹ˆ í–‰ ì²˜ë¦¬
  tagRows.forEach(row => {
    const tagList = row.querySelector('.tag-list');
    const visibleTags = tagList.querySelectorAll('.tag-item[style="display: inline-flex"], .tag-item:not([style*="display: none"])');
    const emptyMsg = tagList.querySelector('.empty-tags');
    
    let visibleCount = 0;
    tagList.querySelectorAll('.tag-item').forEach(tag => {
      if (tag.style.display !== 'none') visibleCount++;
    });
    
    if (visibleCount === 0) {
      emptyMsg.style.display = 'inline';
      row.style.opacity = '0.5';
    } else {
      emptyMsg.style.display = 'none';
      row.style.opacity = '1';
    }
  });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¹ˆ í–‰ ìˆ¨ê¸°ê¸°
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.tag-row').forEach(row => {
    const tagList = row.querySelector('.tag-list');
    const tagCount = tagList.querySelectorAll('.tag-item').length;
    if (tagCount === 0) {
      row.style.display = 'none';
    }
  });
});
</script>
{% endblock %}
