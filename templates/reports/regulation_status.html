{% extends 'base.html' %}

{% block title %}사규 현황 보고서 - 사규관리 시스템{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'reports:index' %}">보고서</a></li>
<li class="breadcrumb-item active">사규 현황</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="page-title mb-0"><i class="bi bi-file-earmark-spreadsheet me-2"></i>사규 현황 보고서</h1>
  <a href="{% url 'reports:status_export' %}?{{ request.GET.urlencode }}" class="btn btn-success">
    <i class="bi bi-download me-1"></i>Excel 다운로드
  </a>
</div>

<!-- 필터 -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">분류</label>
        <select class="form-select" name="category">
          <option value="">전체</option>
          <option value="POLICY" {% if selected_category == 'POLICY' %}selected{% endif %}>정책/방침</option>
          <option value="REGULATION" {% if selected_category == 'REGULATION' %}selected{% endif %}>규정</option>
          <option value="GUIDELINE" {% if selected_category == 'GUIDELINE' %}selected{% endif %}>지침</option>
          <option value="MANUAL" {% if selected_category == 'MANUAL' %}selected{% endif %}>매뉴얼/가이드라인</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">상태</label>
        <select class="form-select" name="status">
          <option value="">전체</option>
          <option value="DRAFT" {% if selected_status == 'DRAFT' %}selected{% endif %}>초안</option>
          <option value="REVIEW" {% if selected_status == 'REVIEW' %}selected{% endif %}>검토중</option>
          <option value="ACTIVE" {% if selected_status == 'ACTIVE' %}selected{% endif %}>시행중</option>
          <option value="ABOLISHED" {% if selected_status == 'ABOLISHED' %}selected{% endif %}>폐지</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">책임부서</label>
        <select class="form-select" name="department">
          <option value="">전체</option>
          {% for dept in departments %}
          <option value="{{ dept.pk }}" {% if selected_dept == dept.pk|stringformat:"s" %}selected{% endif %}>{{ dept.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">조회</button>
        <a href="{% url 'reports:status' %}" class="btn btn-outline-secondary">초기화</a>
      </div>
    </form>
  </div>
</div>

<!-- 요약 통계 -->
<div class="row mb-4">
  <div class="col-md-4 mb-3">
    <div class="card bg-light">
      <div class="card-body text-center">
        <h3 class="text-primary mb-0">{{ total_count }}</h3>
        <small class="text-muted">전체 사규</small>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card bg-light">
      <div class="card-body">
        <h6 class="text-muted mb-2">분류별</h6>
        {% for stat in category_stats %}
        <span class="badge {% if stat.category == 'POLICY' %}bg-danger{% elif stat.category == 'REGULATION' %}bg-primary{% elif stat.category == 'GUIDELINE' %}bg-success{% else %}bg-secondary{% endif %} me-1">
          {{ stat.category }}: {{ stat.count }}
        </span>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card bg-light">
      <div class="card-body">
        <h6 class="text-muted mb-2">상태별</h6>
        {% for stat in status_stats %}
        <span class="badge {% if stat.status == 'ACTIVE' %}bg-success{% elif stat.status == 'DRAFT' %}bg-warning{% elif stat.status == 'REVIEW' %}bg-info{% else %}bg-secondary{% endif %} me-1">
          {{ stat.status }}: {{ stat.count }}
        </span>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- 목록 -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>사규코드</th>
            <th>사규명</th>
            <th>분류</th>
            <th>상태</th>
            <th>의무</th>
            <th>책임부서</th>
            <th>버전</th>
            <th>시행일</th>
          </tr>
        </thead>
        <tbody>
          {% for reg in regulations %}
          <tr>
            <td><a href="{% url 'regulations:detail' reg.pk %}" class="fw-bold text-decoration-none">{{ reg.code }}</a></td>
            <td>{{ reg.title }}</td>
            <td><span class="badge {{ reg.get_category_display_class }}">{{ reg.get_category_display }}</span></td>
            <td><span class="badge {% if reg.status == 'ACTIVE' %}bg-success{% elif reg.status == 'DRAFT' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ reg.get_status_display }}</span></td>
            <td>{% if reg.is_mandatory %}<span class="badge bg-danger">의무</span>{% else %}<span class="badge bg-secondary">비의무</span>{% endif %}</td>
            <td>{{ reg.responsible_dept.name|default:"-" }}</td>
            <td>v{{ reg.current_version }}</td>
            <td>{{ reg.effective_date|date:"Y-m-d"|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted py-5">데이터가 없습니다.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}






