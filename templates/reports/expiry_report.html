{% extends 'base.html' %}

{% block title %}만료예정 보고서 - 사규관리 시스템{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'reports:index' %}">보고서</a></li>
<li class="breadcrumb-item active">만료예정</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="page-title mb-0"><i class="bi bi-calendar-event me-2"></i>만료예정 보고서</h1>
  <a href="{% url 'reports:expiry_export' %}?days={{ selected_days }}" class="btn btn-success">
    <i class="bi bi-download me-1"></i>Excel 다운로드
  </a>
</div>

{% if is_dept_manager %}
<div class="alert alert-info mb-4">
  <i class="bi bi-info-circle me-2"></i>
  <strong>{{ user.department.name }}</strong> 소속 책임부서담당자로 로그인하셨습니다. 
  본인이 담당하는 사규의 만료예정만 표시됩니다.
</div>
{% endif %}

<!-- 필터 -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label">조회 기간</label>
        <select class="form-select" name="days">
          <option value="7" {% if selected_days == 7 %}selected{% endif %}>7일 이내</option>
          <option value="14" {% if selected_days == 14 %}selected{% endif %}>14일 이내</option>
          <option value="30" {% if selected_days == 30 %}selected{% endif %}>30일 이내</option>
          <option value="60" {% if selected_days == 60 %}selected{% endif %}>60일 이내</option>
          <option value="90" {% if selected_days == 90 %}selected{% endif %}>90일 이내</option>
        </select>
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-primary">조회</button>
      </div>
    </form>
  </div>
</div>

<!-- 결과 -->
<div class="alert alert-warning">
  <i class="bi bi-exclamation-triangle me-2"></i>
  <strong>{{ target_date|date:"Y년 m월 d일" }}</strong>까지 정기검토가 필요한 사규가 
  <strong>{{ total_count }}건</strong> 있습니다.
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>사규코드</th>
            <th>사규명</th>
            <th>분류</th>
            <th>책임부서</th>
            <th>정기검토예정일</th>
            <th>남은일수</th>
          </tr>
        </thead>
        <tbody>
          {% for reg in regulations %}
          {% with days_left=reg.expiry_date|timeuntil %}
          <tr class="{% if 'day' in days_left and days_left|slice:':2'|add:'0' <= 7 %}table-danger{% elif 'day' in days_left and days_left|slice:':2'|add:'0' <= 14 %}table-warning{% endif %}">
            <td>
              <a href="{% url 'regulations:detail' reg.pk %}" class="fw-bold text-decoration-none">
                {{ reg.code }}
              </a>
            </td>
            <td>{{ reg.title }}</td>
            <td>
              <span class="badge {{ reg.get_category_display_class }}">
                {{ reg.get_category_display }}
              </span>
            </td>
            <td>{{ reg.responsible_dept.name|default:"-" }}</td>
            <td>{{ reg.expiry_date|date:"Y-m-d" }}</td>
            <td>
              <span class="badge bg-warning text-dark">
                {{ days_left }}
              </span>
            </td>
          </tr>
          {% endwith %}
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-muted py-5">
              <i class="bi bi-check-circle fs-1 text-success d-block mb-2"></i>
              만료예정 사규가 없습니다.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
